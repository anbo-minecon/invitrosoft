<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Reactivos</title>
    <link rel="stylesheet" href="css/formul.css">
    <link rel="stylesheet" href="css/header-footer.css">
    <link rel="stylesheet" href="css/reactivos.css">
</head>
<body>
    <!-- Notificaci√≥n tipo banner -->
    <div id="banner-notificacion" class="notification"></div>

    <div class="container">

        <!-- Controles -->
        <div class="controls">
            <div class="search-box">
                <span class="search-icon">
                    <!-- SVG lupa -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>
                <input type="text" class="search-input" placeholder="Buscar reactivo..." id="searchInput" autocomplete="off">
            </div>
            <button class="add-btn" onclick="toggleFilter()">
                <span>
                    <!-- SVG filtro -->
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M3 4a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v2a1 1 0 0 1-.293.707l-6.414 6.414A1 1 0 0 0 14 13.414V19a1 1 0 0 1-1.447.894l-4-2A1 1 0 0 1 8 17v-3.586a1 1 0 0 0-.293-.707L1.293 6.707A1 1 0 0 1 1 6V4z"/>
                    </svg>
                </span>
                Filtrar
            </button>
            <button class="add-btn" onclick="openModal()">
                <span>
                    <!-- SVG m√°s -->
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </span>
                Nuevo Reactivo
            </button>
        </div>

        <!-- Tabla responsive -->
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>IMAGEN</th>
                        <th>REACTIVO</th>
                        <th>CATEGOR√çA</th>
                        <th>CANTIDAD</th>
                        <th>VENCIMIENTO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="reactivesTable">
                    <!-- Los reactivos se cargar√°n aqu√≠ din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para crear/editar reactivo -->
    <div class="modal" id="reactiveModal">
        <div class="modal-content">
            <div class="modal-header" style="background:linear-gradient(135deg, var(--primary), var(--primary-light));color:#fff;">
                <h3 class="modal-title" id="modalTitle" style="font-size:1.5em;font-weight:700;">Nuevo Reactivo</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="reactiveForm">
                <div class="modal-body">
                    <div class="form-row" style="display:flex;gap:24px;">
                        <div class="form-group" style="flex:1;">
                            <label class="form-label" for="commonName">Nombre com√∫n</label>
                            <input type="text" class="form-input" id="commonName" placeholder="Ej: √Åcido Sulf√∫rico" required>
                            <div class="error" id="nameError"></div>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label class="form-label" for="chemicalFormula">F√≥rmula qu√≠mica</label>
                            <input type="text" class="form-input" id="chemicalFormula" placeholder="Ej: H‚ÇÇSO‚ÇÑ">
                        </div>
                    </div>
                    <div class="form-row" style="display:flex;gap:24px;">
                        <div class="form-group" style="flex:1;">
                            <label class="form-label" for="category">Categor√≠a</label>
                            <select class="form-select" id="category" required>
                                <option value="">Seleccionar categor√≠a</option>
                            </select>
                            <div class="error" id="categoryError"></div>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label class="form-label" for="unitMeasure">Unidad de medida</label>
                            <input type="text" class="form-input" id="unitMeasure" placeholder="Ej: ml, g, kg">
                        </div>
                    </div>
                    <div class="form-row" style="display:flex;gap:24px;">
                        <div class="form-group" style="flex:1;">
                            <label class="form-label" for="totalQuantity">Cantidad total</label>
                            <input type="number" class="form-input" id="totalQuantity" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label class="form-label" for="expiryDate">Fecha de vencimiento</label>
                            <input type="date" class="form-input" id="expiryDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label class="form-label" for="reactiveImage">Imagen</label>
                            <input type="file" class="form-input" id="reactiveImage" accept="image/*">
                            <div style="margin-top:8px;">
                                <img id="imagePreview" src="" alt="Vista previa" style="max-width:120px; max-height:120px; display:none; border-radius:8px; border:1px solid #eee;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeModal()">
                        <span>‚úñ</span>
                        Cancelar
                    </button>
                    <button type="submit" class="btn-save" id="saveBtn">
                        <span>üíæ</span>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let reactives = [];
        let categories = [];
        let editingId = null;

        // Configuraci√≥n de la API
        const REACTIVE_API = 'db/reactivos.php';
        const CATEGORY_API = 'db/categorias.php';

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadReactives();
            setupEventListeners();
        });

        function showNotification(msg, type = 'success') {
            const banner = document.getElementById('banner-notificacion');
            banner.textContent = msg;
            banner.style.display = 'block';
            banner.className = 'notification ' + (type === 'error' ? 'error' : 'success');
            setTimeout(() => { banner.style.display = 'none'; }, 3500);
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', function() {
                filterReactives(this.value);
            });

            document.getElementById('reactiveForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveReactive();
            });

            document.getElementById('reactiveModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });

            document.getElementById('reactiveImage').addEventListener('change', function() {
                const file = this.files[0];
                const preview = document.getElementById('imagePreview');
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.src = '';
                    preview.style.display = 'none';
                }
            });
        }

        async function loadCategories() {
            try {
                const response = await fetch(CATEGORY_API);
                if (!response.ok) throw new Error('Error al cargar categor√≠as');
                categories = await response.json();
                populateCategorySelect();
            } catch (error) {
                showNotification('No se pudieron cargar las categor√≠as', 'error');
            }
        }

        function populateCategorySelect() {
            const select = document.getElementById('category');
            select.innerHTML = '<option value="">Seleccionar categor√≠a</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.nombre;
                select.appendChild(option);
            });
        }

        async function loadReactives() {
            try {
                const response = await fetch(REACTIVE_API);
                if (!response.ok) throw new Error('Error al cargar reactivos');
                reactives = await response.json();
                renderReactives(reactives);
                updateReactiveCount();
            } catch (error) {
                showNotification('No se pudieron cargar los reactivos', 'error');
            }
        }

        function renderReactives(data) {
            const tbody = document.getElementById('reactivesTable');
            tbody.innerHTML = '';
            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" stroke="#bdbdbd" stroke-width="4"/><path d="M20 44h24M24 24v12m8-12v12" stroke="#bdbdbd" stroke-width="4" stroke-linecap="round"/></svg><h3>No hay reactivos registrados</h3><p>Agrega tu primer reactivo usando el bot√≥n <b>Nuevo Reactivo</b>.</p></div></td></tr>`;
                return;
            }
            data.forEach(reactive => {
                const row = document.createElement('tr');
                const quantity = parseFloat(reactive.cantidad_total) || 0;
                const maxQuantity = 2000;
                
                const minimo = 200;
                const diasParaVencer = calcularDiasParaVencer(reactive.fecha_vencimiento);

                const percentage = Math.min((quantity / maxQuantity) * 100, 100);
                const expiryDays = calculateDaysToExpiry(reactive.fecha_vencimiento);
                const expiryDisplay = formatExpiryDate(reactive.fecha_vencimiento);

                // Alerta por cantidad m√≠nima (solo una vez)
                    if (quantity <= minimo && !reactive.alerta_enviada) {
                        enviarAlertaCorreo(reactive, minimo);
                        reactive.alerta_enviada = true; // marcar como ya enviado
                    }
                // Alerta por vencimiento pr√≥ximo (solo una vez)
                    if (diasParaVencer <= 15 && diasParaVencer >= 0 && !reactive.alerta_enviada_vencimiento) {
                        enviarAlertaCorreo(reactive, diasParaVencer, 'vencimiento');
                        reactive.alerta_enviada_vencimiento = true;
                   }

                row.innerHTML = `
                    <td>${String(reactive.id).padStart(3, '0')}</td>
                    <td>
                        ${reactive.imagen ? `<img src="img/reactivos/${reactive.imagen}" alt="Imagen" style="max-width:40px;max-height:40px;border-radius:6px;margin-top:4px;">` : ''}
                    </td>
                    <td>
                        <div class="reactive-name">${reactive.nombre_comun}</div>
                        <div class="chemical-formula">${formatChemicalFormula(reactive.formula_quimica)}</div>
                    </td>
                    <td>
                        ${reactive.categoria_nombre ? 
                            `<span class="category-tag ${reactive.categoria_nombre.toLowerCase()}">${reactive.categoria_nombre}</span>` 
                            : ''}
                    </td>
                    <td>
                        <div class="quantity-container">
                            <div class="quantity-text">${quantity} / ${maxQuantity} ${reactive.unidad_medida || 'g'}</div>
                            <div class="quantity-bar-container">
                                <div class="quantity-bar" style="width: ${percentage}%"></div>
                            </div>
                            <div class="quantity-status">${quantity < 200 ? 'Bajo' : quantity < 800 ? 'Normal' : 'Alto'}</div>
                        </div>
                    </td>
                    <td>
                        <div class="expiry-container">
                            <div class="expiry-days" style="color:${expiryDays <= 7 ? '#e74c3c' : '#4CAF50'};">‚è∞ ${expiryDays} d√≠as</div>
                            <div class="expiry-date">${expiryDisplay}</div>
                        </div>
                    </td>
                    <td>
                        <div class="actions">
                            <button class="action-btn edit-btn" onclick="editReactive(${reactive.id})" title="Editar">
                                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 20h9" />
                                    <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                                </svg>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteReactive(${reactive.id})" title="Eliminar">
                                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);

                
            });
        }

        function calcularDiasParaVencer(fechaVencimiento) {
            if (!fechaVencimiento) return 9999;
            const hoy = new Date();
            const fecha = new Date(fechaVencimiento);
            const diff = fecha - hoy;
            return Math.ceil(diff / (1000 * 60 * 60 * 24)); // d√≠as
            }
        //alerta de stock para enviar correo
       async function enviarAlertaCorreo(reactive, valor, tipo) {
            const payload = {
                id: reactive.id,
                nombre: reactive.nombre_comun,
                categoria: reactive.categoria_nombre,
                cantidad: reactive.cantidad_total,
                um: reactive.unidad_medida,
                tipo: tipo,
                valor: valor, // puede ser "minimo" o "d√≠as restantes"
                fecha_vencimiento: reactive.fecha_vencimiento
            };

            console.log(`üì¶ Enviando alerta de tipo: ${tipo}`, payload);

            try {
                const res = await fetch('/invitrosoft/main/db/send_alert.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
                });

                if (!res.ok) {
                console.error(`‚ùå Error HTTP: ${res.status} ${res.statusText}`);
                return;
                }

                const text = await res.text();
                console.log("üì© Respuesta del servidor:", text);
                let data;
                try { data = JSON.parse(text); } catch (e) { console.error('‚ö†Ô∏è Error JSON'); return; }

                if (data.success) {
                console.log(`‚úÖ Correo enviado (${tipo}): ${reactive.nombre_comun}`);
                } else {
                console.warn(`‚ö†Ô∏è Error al enviar correo (${tipo}): ${data.error || data.msg}`);
                }

            } catch (err) {
                console.error("üö® Error de red:", err);
            }
            }


        function formatChemicalFormula(formula) {
            if (!formula) return '';
            return formula.replace(/(\d+)/g, '<sub>$1</sub>');
        }

        function calculateDaysToExpiry(expiryDate) {
            if (!expiryDate) return 0;
            const today = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        }

        function formatExpiryDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
        }

        function filterReactives(searchTerm) {
            const filtered = reactives.filter(reactive => 
                reactive.nombre_comun.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (reactive.formula_quimica && reactive.formula_quimica.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (reactive.categoria_nombre && reactive.categoria_nombre.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            renderReactives(filtered);
        }

        function updateReactiveCount() {
            document.getElementById('reactiveCount').textContent = String(reactives.length).padStart(2, '0');
        }

        function openModal(isEdit = false, reactiveData = null) {
            const modal = document.getElementById('reactiveModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('reactiveForm');

            if (isEdit && reactiveData) {
                modalTitle.textContent = 'Editar Reactivo';
                document.getElementById('commonName').value = reactiveData.nombre_comun;
                document.getElementById('chemicalFormula').value = reactiveData.formula_quimica || '';
                document.getElementById('category').value = reactiveData.categoria_id || '';
                document.getElementById('unitMeasure').value = reactiveData.unidad_medida || '';
                document.getElementById('totalQuantity').value = reactiveData.cantidad_total || '';
                document.getElementById('expiryDate').value = reactiveData.fecha_vencimiento || '';
                if (reactiveData.imagen) {
                    document.getElementById('imagePreview').src = 'img/reactivos/' + reactiveData.imagen;
                    document.getElementById('imagePreview').style.display = 'block';
                } else {
                    document.getElementById('imagePreview').src = '';
                    document.getElementById('imagePreview').style.display = 'none';
                }
                editingId = reactiveData.id;
            } else {
                modalTitle.textContent = 'Nuevo Reactivo';
                form.reset();
                document.getElementById('imagePreview').src = '';
                document.getElementById('imagePreview').style.display = 'none';
                editingId = null;
            }

            clearErrors();
            document.body.classList.add('modal-open');
            modal.classList.add('active');
        }

        function closeModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('reactiveModal').classList.remove('active');
            document.getElementById('reactiveForm').reset();
            editingId = null;
            clearErrors();
        }

        function clearErrors() {
            document.getElementById('nameError').textContent = '';
            document.getElementById('categoryError').textContent = '';
        }

        async function saveReactive() {
            const form = document.getElementById('reactiveForm');
            const saveBtn = document.getElementById('saveBtn');
            clearErrors();

            const commonName = document.getElementById('commonName').value.trim();
            if (!commonName) {
                document.getElementById('nameError').textContent = 'El nombre com√∫n es obligatorio';
                return;
            }

            const formData = new FormData();
            formData.append('nombre_comun', commonName);
            formData.append('formula_quimica', document.getElementById('chemicalFormula').value.trim());
            formData.append('categoria_id', document.getElementById('category').value || '');
            formData.append('unidad_medida', document.getElementById('unitMeasure').value.trim());
            formData.append('cantidad_total', document.getElementById('totalQuantity').value || 0);
            formData.append('fecha_vencimiento', document.getElementById('expiryDate').value || '');
            const imageFile = document.getElementById('reactiveImage').files[0];
            if (imageFile) formData.append('imagen', imageFile);

            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span>‚è≥</span> Guardando...';

                let response;
                if (editingId) {
                    formData.append('id', editingId);
                    response = await fetch(`${REACTIVE_API}?id=${editingId}`, {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    response = await fetch(REACTIVE_API, {
                        method: 'POST',
                        body: formData
                    });
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error al guardar el reactivo');
                }

                await loadReactives();
                closeModal();
                showNotification('Reactivo guardado correctamente', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
                document.getElementById('nameError').textContent = error.message;
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span>üíæ</span> Guardar';
            }
        }

        function editReactive(id) {
            const reactive = reactives.find(r => r.id == id);
            if (reactive) {
                openModal(true, reactive);
            }
        }

        async function deleteReactive(id) {
            const reactive = reactives.find(r => r.id == id);
            if (!reactive) return;

            if (!confirm(`¬øEst√°s seguro de que deseas eliminar el reactivo "${reactive.nombre_comun}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${REACTIVE_API}?id=${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error al eliminar el reactivo');
                }

                await loadReactives();
                showNotification('Reactivo eliminado correctamente', 'success');
            } catch (error) {
                showNotification('Error al eliminar el reactivo: ' + error.message, 'error');
            }
        }

        function toggleFilter() {
            showNotification('Funci√≥n de filtro en desarrollo', 'error');
        }
    </script>
    <script src="js/header-footer.js"></script>
</body>
</html>